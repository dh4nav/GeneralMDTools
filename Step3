#Check if add cluster has docked onto the center cluster

#import AtomEnsemble as ae

import os
#import sys
import fieldtools as ft
import iotools as iot
import random
#import numpy as np

def frand(minval=0.0, maxval=1.0):
    return random.uniform(minval, maxval)

#seed random
random.seed()

#Get index
#index = int(sys.argv[1])

#Load last frame
last_frame = iot.DLP2HReader(fileobj="HIk")[-1]
lf_copy = last_frame.copy()
lf_copy.filter(keep="BI")

# check if aggregation has occurred. If yes solvate, if not rinse and repeat
if lf_copy.get_chains("BI") != 1:
    os.system("mv REVCON CONFIG; mv REVIVE REVOLD")
    # start step2
else:
    solvate_hull = iot.DLP2HReader(fileobj="SolvateHull")[0]
    len_last_frame = len(last_frame['element'])
    last_frame.center()
    solvate_hull.center()
    last_frame.intersect_molecules(solvate_hull, 3.5, 4)

    #construct field file
    ff = ft.FieldCollection(input_file="FIELD_vdw_minus")
    for index, atom in enumerate(last_frame['element']):
        if index < len_last_frame:
            if atom == "BI":
                ff.append_molecule("FIELD_Mol_BI_fixed")
            elif atom == "OI":
                ff.append_molecule("FIELD_Mol_OI_fixed")
            elif atom == "OH":
                ff.append_molecule("FIELD_Mol_OH_fixed")
            elif atom == "NN":
                ff.append_molecule("FIELD_Mol_NO3_fixed")
            elif atom == "SD":
                ff.append_molecule("FIELD_Mol_DMSO_fixed")
            elif atom == "OW":
                ff.append_molecule("FIELD_Mol_H2O_fixed")
        else:
            if atom == "BI":
                ff.append_molecule("FIELD_Mol_BI")
            elif atom == "OI":
                ff.append_molecule("FIELD_Mol_OI")
            elif atom == "OH":
                ff.append_molecule("FIELD_Mol_OH")
            elif atom == "NN":
                ff.append_molecule("FIELD_Mol_NO3")
            elif atom == "SD":
                ff.append_molecule("FIELD_Mol_DMSO")
            elif atom == "OW":
                ff.append_molecule("FIELD_Mol_H2O")

    field_out = open("FIELD", "w")
    field_out.write(str(ff))
    field_out.close()

    field_out = open("FIELD3", "w")
    field_out.write(str(ff))
    field_out.close()

    last_frame.boxvector = last_frame.get_bounding_box()

    conf_writer = iot.DLP2CWriter(fileobj="CONFIG", overwrite=True)
    conf_writer.write(last_frame)
    del conf_writer

    conf_writer = iot.DLP2CWriter(fileobj="CONFIG3", overwrite=True)
    conf_writer.write(last_frame)
    del conf_writer

    # start 4
